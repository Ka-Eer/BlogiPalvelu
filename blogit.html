<!-- blogit.html 
    sivulla näytetään yksittäinen blogipostaus id-parametrin perusteella
-->
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blogi - Postaus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="galleria.css">
</head>
<body>
<header class="Header_Top">
    <h1 class="text-center">Blogi</h1>
</header>

<!-- Navigaatio -->
<nav class="navbar navbar-expand-sm navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Logo</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Etusivu</a></li>
                <li class="nav-item"><a class="nav-link" href="blogi.html">Blogi</a></li>
                <li class="nav-item"><a class="nav-link" href="galleria.html">Galleria</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Pääsisältö -->
<main class="container py-4" id="post-root">
    <div id="post" class="">
        <!-- Postaus renderöidään tänne -->
        <div id="loading" class="text-center py-5">Ladataan...</div>
    </div>
</main>

<!-- Scriptit -->
<script>
// Hakee id param ja näyttää postauksen
(function() {
    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const root = document.getElementById('post');
    const loading = document.getElementById('loading');

    if (!id) {
        root.innerHTML = '<div class="alert alert-warning">Postauksen ID puuttuu URL-osoitteesta.</div>';
        return;
    }

    fetch('get_post.php?id=' + encodeURIComponent(id))
        .then(resp => {
            if (!resp.ok) {
                if (resp.status === 404) throw new Error('Postausta ei löydy');
                throw new Error('Palvelinvirhe');
            }
            return resp.json();
        })
        .then(data => {
            // Jos palvelin palauttaa error-objektin
            if (data && data.error) {
                root.innerHTML = '<div class="alert alert-danger">' + escapeHtml(data.error) + '</div>';
                return;
            }

            // renderöidään post
            const title = escapeHtml(data.Otsikko || '');
            const date = escapeHtml(data.Pvm || '');
            const time = escapeHtml((data.Klo || '').slice(0,5));
            const likes = Number(data.Tykkaykset || 0);
            const content = data.Teksti || '';
            const imgSrc = data.Kuvasrc || null;

            // tagit vastaavat BT1..BT11
            const tagLabels = ['Pelit','Matkustaminen','Teknologia & Internet','Oppiminen & Itsekehitys','Ruoka & Juoma','Hyvinvointi & Elämäntyyli','Luovuus & Kulttuuri','Työ & Ura','Koti & Arki','Tee se itse & Projektit','Ympäristö & Luonto'];

            let html = '';
            html += '<div class="mb-4">';
            // Kuva
            if (imgSrc) {
                html += '<img src="' + escapeHtml(imgSrc) + '" class="" style="max-width:100%;height:auto;" alt="Postauksen kuva">';
            }
            html += '<div class="">';
            // Otsikko
            html += '<h2 class="">' + title + '</h2>';

            // renderöidään tagit Bootstrap badgeina
            let tagsHtml = '';
            for (let i = 0; i < tagLabels.length; i++) {
                const key = 'BT' + (i + 1);
                if (data[key]) {
                    tagsHtml += '<span class="badge bg-primary me-1">' + escapeHtml(tagLabels[i]) + '</span>';
                }
            }
            if (tagsHtml) {
                html += '<div class="mb-2">' + tagsHtml + '</div>';
            }

            // Likes renderöidään: sydän-painike + laskuri
            const postId = data.ID;
            let likeHtml = '';
            likeHtml += '<div class="d-flex align-items-center mb-3">';
            likeHtml += '<div class="me-2">';
            likeHtml += '<button class="heart-button" data-id="' + escapeHtml(postId) + '" aria-pressed="false" title="Tykkää" aria-label="Tykkää">';
            likeHtml += '<svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3 c1.74 0 3.41.81 4.5 2.09 C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5 c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
            likeHtml += '</button>';
            likeHtml += '</div>';
            likeHtml += '<div><span id="likes-' + escapeHtml(postId) + '" class="like-count">' + likes + '</span></div>';
            likeHtml += '</div>';

            html += '<div class="text-muted mb-3">' + date + ' ' + time + ' &middot; </div>' + likeHtml;
            // Säilytä rivinvaihdot perus-HTML:ksi
            const paragraphs = content.split(/\r?\n\r?\n/).map(p => '<p>' + escapeHtml(p).replace(/\n/g, '<br>') + '</p>').join('\n');
            html += '<div class="">' + paragraphs + '</div>';
            html += '</div>';
            html += '</div>';

            root.innerHTML = html;

            // Liitetään tykkäyspainikkeiden kuuntelijat
            function toggleLike(button) {
                const id = button.getAttribute('data-id');
                const countEl = document.getElementById(`likes-${id}`);
                if (!countEl) return;

                const liked = button.classList.toggle('liked');

                button.classList.add('pop');
                setTimeout(() => button.classList.remove('pop'), 300);

                let count = parseInt(countEl.textContent) || 0;
                count = liked ? count + 1 : Math.max(0, count - 1);
                countEl.textContent = count;

                button.setAttribute('aria-pressed', liked ? 'true' : 'false');
                button.title = liked ? 'Poista tykkäys' : 'Tykkää';
            }

            const likeBtn = root.querySelector('.heart-button');
            if (likeBtn) {
                likeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleLike(likeBtn);
                });
                likeBtn.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        toggleLike(likeBtn);
                    }
                });
            }
        })
        .catch(err => {
            console.error(err);
            root.innerHTML = '<div class="alert alert-danger">' + escapeHtml(err.message || 'Virhe haettaessa postausta') + '</div>';
        })
        .finally(() => {
            if (loading && loading.parentNode) loading.remove();
        });
})();
</script>

</body>
</html>
